<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Old Newspaper Scheduler</title>
<style>
  /* ---------------- Base / Newspaper look ---------------- */
  :root{
    --paper:#fff8e7;
    --bg:#f4efe4;
    --accent:#d4c29a;
    --text:#2b2b2b;
    --muted:#6b6658;
    --danger:#b84a4a;
    --maxw:420px;
  }
  html,body{height:100%;margin:0;font-family:"Times New Roman",Times,serif;background:var(--bg);color:var(--text);}
  .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:28px 12px;}
  .card{
    width:100%;max-width:var(--maxw);
    background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,250,240,0.95));
    border:2px solid #000;padding:16px;border-radius:4px;
    box-shadow:6px 8px 0 rgba(0,0,0,0.12);
  }
  header{text-align:center;border-bottom:3px double #000;padding-bottom:8px;margin-bottom:12px;}
  header h1{margin:0;font-size:1.5rem;letter-spacing:1px}
  .clock{font-weight:bold;font-size:1.25rem;margin-top:8px;color:var(--muted)}
  /* main list */
  #todayTitle{font-size:1rem;margin:10px 0 6px 0;text-align:center;color:var(--muted)}
  .task-list{list-style:none;padding:6px 0;margin:0}
  .task-item{
    display:flex;align-items:center;justify-content:space-between;
    background:var(--paper);border:1px solid #000;padding:8px 10px;margin-bottom:8px;
    font-size:0.95rem;
  }
  .task-left{display:flex;flex-direction:column;gap:4px}
  .task-meta{font-size:0.82rem;color:var(--muted)}
  .task-cat{font-style:italic;color:#4a3d2a}
  .task-actions{display:flex;gap:6px;align-items:center}
  .btn{background:var(--accent);border:1px solid #000;padding:6px 10px;cursor:pointer;font-weight:bold}
  .btn:active{transform:translateY(1px)}
  .btn-plain{background:transparent;border:1px solid #000;padding:6px 8px}
  .remove{background:var(--danger);color:#fff;border:none;padding:6px 8px;cursor:pointer}
  .small{font-size:0.85rem}
  /* modal / advanced panel */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:20px}
  .modal{width:100%;max-width:520px;background:var(--paper);border:2px solid #000;padding:14px;border-radius:3px;box-shadow:8px 10px 0 rgba(0,0,0,0.15)}
  .modal h2{text-align:center;margin:0 0 10px 0}
  .form-row{display:flex;flex-direction:column;margin-bottom:8px}
  .form-row.inline{flex-direction:row;gap:8px}
  input[type="text"], input[type="date"], input[type="time"], input[type="file"], select, textarea{
    padding:8px;border:1px solid #000;background:rgba(255,255,255,0.95);font-family:inherit;
  }
  textarea{min-height:60px}
  label{font-weight:bold;font-size:0.85rem;margin-bottom:4px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .search-row{display:flex;gap:8px;align-items:center;margin-top:10px}
  .muted{color:var(--muted);font-size:0.9rem}
  footer{margin-top:12px;text-align:center;font-size:0.85rem;color:var(--muted)}
  /* responsive */
  @media(max-width:520px){
    .modal{max-width:100%}
    .form-row.inline{flex-direction:column}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="card" role="application" aria-labelledby="appTitle">
    <header>
      <h1 id="appTitle">📰 Old Times Scheduler</h1>
      <div id="clock" class="clock" aria-live="polite">--:--:--</div>
      <div style="margin-top:10px">
        <button id="openAdvanced" class="btn" title="Open advanced task manager">Advanced ▾</button>
      </div>
    </header>

    <main>
      <div id="todayTitle">Today's tasks</div>
      <ul id="todayList" class="task-list" aria-live="polite">
        <!-- today items inserted here -->
      </ul>

      <div style="text-align:center;margin-top:8px">
        <span class="muted small">Tip: open Advanced to add / manage tasks</span>
      </div>
    </main>

    <footer>
      <small class="muted">All data stored locally in your browser. Works offline while the page is open.</small>
    </footer>
  </div>
</div>

<!-- Modal / Advanced panel -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2>Advanced — Add / Manage Tasks</h2>

    <form id="taskForm">
      <div class="form-row">
        <label for="taskName">Task title</label>
        <input id="taskName" type="text" placeholder="Write a short title" required>
      </div>

      <div class="form-row inline">
        <div style="flex:1">
          <label for="taskDate">Date</label>
          <input id="taskDate" type="date" required>
        </div>
        <div style="width:120px">
          <label for="taskTime">Time</label>
          <input id="taskTime" type="time" required>
        </div>
      </div>

      <div class="form-row inline">
        <div style="flex:1">
          <label for="taskCategory">Category</label>
          <select id="taskCategory">
            <option value="Work">Work</option>
            <option value="Personal">Personal</option>
            <option value="Health">Health</option>
            <option value="Study">Study</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div style="width:140px">
          <label for="taskRepeat">Repeat</label>
          <select id="taskRepeat">
            <option value="none">None</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <label for="taskMessage">Custom alert message (optional)</label>
        <input id="taskMessage" type="text" placeholder="What should the alert say? (default: title)">
      </div>

      <div class="form-row">
        <label for="audioFile">Audio reminder (optional)</label>
        <input id="audioFile" type="file" accept="audio/*">
        <small class="muted">If you upload audio, it will play when the task triggers (local only).</small>
      </div>

      <div class="controls">
        <button type="submit" class="btn">Add / Save Task</button>
        <button type="button" id="exportBtn" class="btn-plain">Export JSON</button>
        <button type="button" id="importBtn" class="btn-plain">Import JSON</button>
        <button type="button" id="closeModal" class="btn-plain">Close</button>
      </div>

      <hr style="margin:12px 0">

      <div class="search-row">
        <input id="searchInput" type="text" placeholder="Search by title or category..." style="flex:1;padding:8px;border:1px solid #000">
        <button id="clearSearch" type="button" class="btn-plain">Clear</button>
      </div>

      <div style="margin-top:12px">
        <div id="manageList" style="max-height:240px;overflow:auto"></div>
      </div>
    </form>
  </div>
</div>

<!-- single audio element used for playing uploaded or default sound -->
<audio id="player" preload="auto"></audio>

<script>
/* ===================== Scheduler App (single-file) ===================== */
/* Data model:
   tasks = [
     { id, title, date: 'YYYY-MM-DD', time: 'HH:MM', category, repeat: 'none'|'daily'|'weekly'|'monthly',
       message, audioDataUrl (optional) }
   ]
*/
const STORAGE_KEY = 'old_newspaper_tasks_v1';
let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

// UI refs
const clockEl = document.getElementById('clock');
const openAdvanced = document.getElementById('openAdvanced');
const modalBackdrop = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModal');
const taskForm = document.getElementById('taskForm');
const todayList = document.getElementById('todayList');
const manageList = document.getElementById('manageList');
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const player = document.getElementById('player');

// Form fields
const fTitle = document.getElementById('taskName');
const fDate = document.getElementById('taskDate');
const fTime = document.getElementById('taskTime');
const fCategory = document.getElementById('taskCategory');
const fRepeat = document.getElementById('taskRepeat');
const fMessage = document.getElementById('taskMessage');
const fAudio = document.getElementById('audioFile');

/* ------------------ Helpers ------------------ */
function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function todayISO(){ return (new Date()).toISOString().split('T')[0]; }
function timeNowHHMM(){ return (new Date()).toTimeString().slice(0,5); }

/* ------------------ Clock ------------------ */
function updateClock(){
  const now = new Date();
  clockEl.textContent = now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

/* ------------------ Modal open/close ------------------ */
openAdvanced.addEventListener('click', ()=>openModal());
closeModalBtn.addEventListener('click', ()=>closeModal());
modalBackdrop.addEventListener('click', (e)=>{
  if(e.target === modalBackdrop) closeModal();
});
function openModal(){
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  refreshManageList();
}
function closeModal(){
  modalBackdrop.style.display = 'none';
  modalBackdrop.setAttribute('aria-hidden','true');
  resetForm();
}

/* ------------------ Render today's tasks (main page) ------------------ */
function renderToday(){
  todayList.innerHTML = '';
  const today = todayISO();
  const todayTasks = tasks
    .filter(t => t.date === today)
    .sort((a,b) => a.time.localeCompare(b.time));

  if(todayTasks.length === 0){
    const p = document.createElement('li');
    p.className = 'task-item';
    p.innerHTML = '<div class="task-left"><div class="task-meta">No tasks for today</div></div>';
    todayList.appendChild(p);
    return;
  }

  todayTasks.forEach(t=>{
    const li = document.createElement('li'); li.className='task-item';
    const left = document.createElement('div'); left.className='task-left';
    const title = document.createElement('div'); title.textContent = t.title;
    const meta = document.createElement('div'); meta.className='task-meta';
    meta.innerHTML = `${t.date} • ${t.time} <span class="task-cat">[${t.category||'—'}]</span>`;
    left.appendChild(title); left.appendChild(meta);

    const actions = document.createElement('div'); actions.className='task-actions';
    const removeBtn = document.createElement('button'); removeBtn.className='remove';
    removeBtn.textContent = 'Remove';
    removeBtn.title = 'Remove this task';
    removeBtn.addEventListener('click', ()=>{ removeTask(t.id); });

    const detailsBtn = document.createElement('button'); detailsBtn.className='btn-plain';
    detailsBtn.textContent = 'Details'; detailsBtn.addEventListener('click', ()=>{ openModal(); highlightTaskInManage(t.id); });

    actions.appendChild(detailsBtn); actions.appendChild(removeBtn);

    li.appendChild(left); li.appendChild(actions);
    todayList.appendChild(li);
  });
}

/* ------------------ Manage list (inside modal) ------------------ */
function refreshManageList(filter=''){
  manageList.innerHTML = '';
  const filtered = tasks
    .filter(t => (t.title.toLowerCase().includes(filter) || (t.category||'').toLowerCase().includes(filter)))
    .sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));

  if(filtered.length===0){
    manageList.innerHTML = '<div class="muted small" style="padding:8px">No tasks match.</div>';
    return;
  }

  filtered.forEach(t=>{
    const row = document.createElement('div');
    row.style.borderBottom='1px dashed #000'; row.style.padding='8px'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:bold">${t.title}</div>
                      <div class="muted small">${t.date} • ${t.time} • <span class="task-cat">[${t.category||'—'}]</span> ${t.repeat && t.repeat!=='none' ? ' • 🔁 ' + t.repeat : ''}</div>
                      <div class="small" style="margin-top:6px">${t.message? t.message : ''}</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
    const editBtn = document.createElement('button'); editBtn.className='btn-plain'; editBtn.textContent='Edit';
    editBtn.addEventListener('click', ()=> populateFormForEdit(t.id));
    const delBtn = document.createElement('button'); delBtn.className='remove'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', ()=> { if(confirm('Delete this task?')) { removeTask(t.id); refreshManageList(searchInput.value.trim().toLowerCase()); }});
    right.appendChild(editBtn); right.appendChild(delBtn);

    row.appendChild(left); row.appendChild(right);
    manageList.appendChild(row);
  });
}

/* ------------------ Add / Edit form handling ------------------ */
let editingId = null;

taskForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const title = fTitle.value.trim();
  const date = fDate.value;
  const time = fTime.value;
  const category = fCategory.value;
  const repeat = fRepeat.value;
  const message = fMessage.value.trim();

  if(!title || !date || !time){ alert('Please fill title, date and time.'); return; }

  // handle audio file: read as data URL if provided
  let audioDataUrl = null;
  if(fAudio.files && fAudio.files[0]){
    audioDataUrl = await fileToDataUrl(fAudio.files[0]);
  }

  if(editingId){
    // update existing
    const idx = tasks.findIndex(t => t.id === editingId);
    if(idx !== -1){
      tasks[idx] = {...tasks[idx], title, date, time, category, repeat, message: message || tasks[idx].message, audioDataUrl: audioDataUrl || tasks[idx].audioDataUrl};
    }
    editingId = null;
  } else {
    tasks.push({
      id: uid(), title, date, time, category, repeat, message: message || title, audioDataUrl
    });
  }

  save();
  refreshManageList(searchInput.value.trim().toLowerCase());
  renderToday();
  taskForm.reset();
  // keep modal open to manage more items
});

/* File to dataURL helper */
function fileToDataUrl(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = ()=>rej();
    r.readAsDataURL(file);
  });
}

/* populate form to edit */
function populateFormForEdit(id){
  const t = tasks.find(x => x.id === id);
  if(!t) return;
  editingId = t.id;
  fTitle.value = t.title;
  fDate.value = t.date;
  fTime.value = t.time;
  fCategory.value = t.category || 'Other';
  fRepeat.value = t.repeat || 'none';
  fMessage.value = t.message || '';
  // audio input can't be set programmatically for security; user can re-upload if needed
  openModal();
  // scroll manage list to this item
  highlightTaskInManage(id);
}

/* Highlight task row in manage list (visual) */
function highlightTaskInManage(id){
  // simple approach: refresh and then scroll first matching element into view
  refreshManageList(searchInput.value.trim().toLowerCase());
  const rows = manageList.querySelectorAll('div[style]');
  for(const r of rows){
    if(r.innerText.includes(id)) continue; // id not present in text; skip
  }
  // no-op; user can see list and edit
}

/* ------------------ Remove task ------------------ */
function removeTask(id){
  tasks = tasks.filter(t=>t.id !== id);
  save();
  renderToday();
  refreshManageList(searchInput.value.trim().toLowerCase());
}

/* ------------------ Search in modal ------------------ */
searchInput.addEventListener('input', ()=> {
  const q = searchInput.value.trim().toLowerCase();
  refreshManageList(q);
});
clearSearch.addEventListener('click', ()=>{ searchInput.value=''; refreshManageList(''); });

/* ------------------ Export / Import JSON ------------------ */
exportBtn.addEventListener('click', ()=>{
  const dataStr = JSON.stringify(tasks, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'tasks.json'; a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> {
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const imported = JSON.parse(ev.target.result);
        if(Array.isArray(imported)){
          // basic validation
          imported.forEach(it=>{
            if(!it.id) it.id = uid();
          });
          tasks = imported;
          save();
          refreshManageList('');
          renderToday();
          alert('Imported tasks.');
        } else alert('Invalid file.');
      }catch(err){ alert('Could not parse JSON.'); }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* ------------------ Notification & audio behavior ------------------ */
async function notifyUser(title, body, audioDataUrl){
  // browser Notification (if allowed)
  if('Notification' in window && Notification.permission === 'granted'){
    try{
      new Notification(title, { body, icon: null });
    }catch(e){ /* ignore failures */ }
  } else if('Notification' in window && Notification.permission !== 'denied'){
    // ask
    try{ const p = await Notification.requestPermission(); }catch(e){}
  }

  // play audio if provided, else use default beep
  if(audioDataUrl){
    player.src = audioDataUrl;
    player.play().catch(()=>{ /* ignore */ });
  } else {
    // short beep fallback (built-in very small oscillator approach)
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.value = 0.04;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 350);
    }catch(e){ /* ignore */ }
  }
}

/* ------------------ Reminder checker (runs periodically) ------------------ */
function checkReminders(){
  const now = new Date();
  const curDate = now.toISOString().split('T')[0];
  const curTime = now.toTimeString().slice(0,5);

  // copy to avoid mutation while iterating
  tasks.slice().forEach(t=>{
    if(t.date === curDate && t.time === curTime){
      // trigger alert/notification
      notifyUser(t.title, t.message || t.title, t.audioDataUrl).catch?.(()=>{});
      // reschedule if recurring, otherwise remove
      if(t.repeat === 'daily'){
        const next = new Date(t.date + 'T' + t.time + ':00');
        next.setDate(next.getDate() + 1);
        t.date = next.toISOString().split('T')[0];
      } else if(t.repeat === 'weekly'){
        const next = new Date(t.date + 'T' + t.time + ':00');
        next.setDate(next.getDate() + 7);
        t.date = next.toISOString().split('T')[0];
      } else if(t.repeat === 'monthly'){
        const next = new Date(t.date + 'T' + t.time + ':00');
        next.setMonth(next.getMonth() + 1);
        t.date = next.toISOString().split('T')[0];
      } else {
        // remove one-time task
        tasks = tasks.filter(x => x.id !== t.id);
      }
      save();
      renderToday();
      refreshManageList(searchInput.value.trim().toLowerCase());
    }
  });
}

// check every 30 seconds
setInterval(checkReminders, 30_000);
checkReminders(); // try once immediately on load

/* ------------------ Init render ------------------ */
function resetForm(){
  editingId = null;
  taskForm.reset();
}
renderToday();
refreshManageList();

/* ------------------ keyboard: Esc closes modal ------------------ */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

</script>
</body>
</html>
